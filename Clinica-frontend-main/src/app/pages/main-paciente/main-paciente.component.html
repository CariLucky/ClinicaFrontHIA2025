<div class="container py-4">
  <div class="row g-4">
    <!-- Perfil Paciente -->
    <div class="col-12 col-lg-4">
      <div class="perfil-section d-flex flex-column gap-3 p-4 bg-white h-100">
        <div class="d-flex align-items-center gap-4">
          <i class="bi bi-person-circle text-primary" style="font-size: 3rem"></i>
          <div>
            <div class="fw-bold fs-4">{{ paciente.nombre }} {{ paciente.apellido }}</div>
            <div class="text-muted small">{{ paciente.email || 'Sin email registrado' }}</div>
            <div class="text-muted small">DNI: {{ paciente.dni }}</div>
          </div>
        </div>

        <hr class="my-2" />
        <div class="d-flex flex-column gap-2">
          <button class="btn btn-outline-primary w-100" (click)="abrirModalEditarPerfil()"><i
              class="bi bi-pencil-square"></i> Editar perfil</button>
          <button class="btn btn-outline-secondary w-100" (click)="onForgotPassword()"><i class="bi bi-key"></i> Cambiar
            contraseña</button>
        </div>
      </div>
    </div>

    <!-- Turnos -->
    <div class="col-12 col-lg-8">
      <div class="turnos-section bg-white p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0"><i class="bi bi-calendar2-check text-primary"></i> Mis Turnos</h2>
          <div class="d-flex gap-2">
            <div class="dropdown" (mouseleave)="filtroDropdownAbierto = false">
              <button class="btn btn-outline-primary" (click)="toggleFiltroDropdown()">
                <i class="bi" [ngClass]="getEstadoFiltroIcon()"></i> {{ getEstadoFiltroLabel() }}
              </button>
              <ul *ngIf="filtroDropdownAbierto" class="dropdown-menu show" style="display:block;">
                <li *ngFor="let estado of estadosTurno"><button class="dropdown-item"
                    (click)="onEstadoFiltroChange(estado.value)"><i class="bi" [ngClass]="estado.icon"></i> {{
                    estado.label }}</button></li>
              </ul>
            </div>
            <button class="btn btn-primary" (click)="onClickSolicitarTurno()">Nuevo Turno</button>
          </div>
        </div>

        <ng-container *ngIf="mostrarDoctores">
          <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-person-badge text-primary"></i> Selecciona un doctor</h5>
              <button class="btn btn-outline-danger" (click)="onCerrarDoctores()">Cerrar</button>
            </div>
            <app-list-doctores [pacienteId]="pacienteId" [mostrarBotonTurno]="true"
              (cerrar)="onCerrarDoctores()"></app-list-doctores>
          </div>
        </ng-container>

        <ng-container *ngIf="!mostrarDoctores">
          <div class="turnos-scroll" style="max-height:60vh; overflow-y:auto;">
            <ng-container *ngIf="tieneTurnos; else sinTurnos">
              <div *ngFor="let turno of turnos" class="card mb-3 p-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">{{ turno.doctor.especialidad.nombre }} - {{ turno.doctor.nombre }}</div>
                    <div class="text-muted small">{{ turno.fecha }} • {{ turno.hora }}</div>
                  </div>
                  <div class="text-end">
                    <span class="badge"
                      [ngClass]="{ 'bg-warning text-dark': turno.estado === 'pendiente', 'bg-success': turno.estado === 'realizado', 'bg-danger': turno.estado === 'cancelado' }">{{
                      turno.estado | titlecase }}</span>
                  </div>
                </div>
                <div class="mt-2 d-flex gap-2">
                  <button class="btn btn-outline-info" (click)="abrirModalDetalle(turno._id)">Ver detalles</button>
                  <button class="btn btn-outline-danger" (click)="mostrarModalCancelar(turno._id)"
                    [disabled]="turno.estado === 'cancelado'">Cancelar</button>
                </div>
              </div>
            </ng-container>

            <ng-template #sinTurnos>
              <div class="text-center py-5">No tienes turnos reservados.</div>
            </ng-template>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- single hidden file input -->
<input type="file" #fileInputComprobante (change)="onArchivoSeleccionado($event)"
  accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="d-none" />

<!-- Confirm Cancel Modal -->
<div *ngIf="mostrarModal" class="modal-backdrop d-block">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="mb-2">Confirmar cancelación</h5>
      <p>¿Estás seguro de que deseas cancelar este turno?</p>
      <div class="d-flex gap-2 justify-content-end">
        <button class="btn btn-secondary" (click)="cerrarModalCancelar()">No</button>
        <button class="btn btn-danger" (click)="confirmarCancelarTurno()">Sí, cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Detalle Modal -->
<ng-container *ngIf="mostrarModalDetalle && detalleTurno">
  <div class="modal-backdrop d-block">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Detalle del Turno</h5>
          <button class="btn btn-sm btn-outline-secondary" (click)="cerrarModalDetalle()">Cerrar</button>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <h6 class="fw-bold">Doctor</h6>
            <div>{{ detalleTurno.doctor.nombre }} {{ detalleTurno.doctor.apellido }}</div>
            <div class="text-muted small">{{ detalleTurno.doctor.especialidad.nombre }}</div>
          </div>
          <div class="col-12 col-md-6">
            <h6 class="fw-bold">Información</h6>
            <div>{{ detalleTurno.fecha }} • {{ detalleTurno.hora }}</div>
            <div class="mt-1">{{ detalleTurno.observaciones || 'Sin observaciones.' }}</div>
          </div>

          <div class="col-12">
            <h6 class="fw-bold">Archivos médicos</h6>
            <ng-container *ngIf="getArchivosMedicos(detalleTurno.archivos).length > 0; else noArchivosMedicos">
              <div class="row g-2">
                <div *ngFor="let archivo of getArchivosMedicos(detalleTurno.archivos)" class="col-12 col-md-6">
                  <div class="card p-2 mb-2">
                    <div class="fw-medium">{{ archivo.nombre }}</div>
                    <small class="text-muted">{{ archivo.fechaSubida | date:'short' }}</small>
                    <div class="mt-2"><a [href]="archivo.url" target="_blank"
                        class="btn btn-outline-primary btn-sm">Ver</a></div>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noArchivosMedicos>
              <div class="alert alert-light">No hay archivos médicos disponibles.</div>
            </ng-template>
          </div>

          <div class="col-12">
            <h6 class="fw-bold">Comprobantes de pago</h6>
            <ng-container *ngIf="getArchivosPago(detalleTurno.archivos).length > 0; else noComprobantes">
              <div *ngFor="let archivo of getArchivosPago(detalleTurno.archivos)" class="card mb-2 p-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-medium">{{ archivo.nombre }}</div>
                    <small class="text-muted">{{ archivo.fechaSubida | date:'short' }}</small>
                  </div>
                  <div class="d-flex gap-2">
                    <a [href]="archivo.url" target="_blank" class="btn btn-outline-success btn-sm">Ver</a>
                    <button *ngIf="detalleTurno.estado === 'pendiente'" class="btn btn-outline-warning btn-sm"
                      (click)="iniciarReemplazoComprobante(archivo)"
                      [disabled]="subiendoComprobante">Reemplazar</button>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noComprobantes>
              <div class="alert alert-light">No hay comprobante de pago subido.</div>
            </ng-template>

            <div *ngIf="detalleTurno.estado === 'pendiente' && getArchivosPago(detalleTurno.archivos).length === 0"
              class="mt-3">
              <button class="btn btn-outline-primary" (click)="iniciarSubidaComprobante()"
                [disabled]="subiendoComprobante">
                <span *ngIf="subiendoComprobante" class="spinner-border spinner-border-sm me-1"></span>
                {{ subiendoComprobante ? 'Subiendo...' : 'Subir comprobante de pago' }}
              </button>
              <div class="alert alert-info mt-2">Después de subir el comprobante, aguarda hasta que lo confirmen en
                administración.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>